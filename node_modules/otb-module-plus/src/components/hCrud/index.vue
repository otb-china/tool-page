<template>
  <div :class="className">
    <!--操作-->
    <div class="space-between">
      <!--搜索项表单-->
      <h-form
        :class-name="search?.className"
        :form="search!.form"
        :form-width="search?.formWidth"
        :item-width="search?.itemWidth"
        :label-width="search?.labelWidth"
        :option="search!.option"
        :rules="search?.rules"
        :size="search?.size || size"
        @change="searchChange"
      />
      <!--操作按钮项表单-->
      <h-form
        :author="author"
        :class-name="operation?.className || 'ML10'"
        :form="operation!.form || {}"
        :form-width="operation?.formWidth"
        :item-width="operation?.itemWidth || 'fit-content'"
        :label-width="operation?.labelWidth"
        :option="operationOption"
        :size="operation?.size || size"
      >
        <template #default="o: RSA">
          <!--导出-->
          <h-export
            :loading="exportOption?.loading"
            :list="exportOption!.list"
            :placement="exportOption?.placement"
            :prop="exportOption?.prop"
            @export-upd="exportUpd"
            @export-del="exportDel"
            @set-export="setExport(o)"
          />
        </template>
      </h-form>
    </div>
    <!--表格-->
    <el-table
      v-loading="loading"
      :border="TRUE(<boolean>option.border)"
      :data="data"
      :element-loading-spinner="option.loadingIcon"
      :element-loading-text="LoadingText(<string>option.LoadingText)"
      :fit="option.fit"
      :height="option.height"
      :highlight-current-row="option.currentRow"
      :max-height="option.maxHeight"
      :show-summary="option.summary"
      :size="size"
      :summary-method="getSummaries"
      @selection-change="selectionChange"
    >
      <el-table-column
        v-for="(item, index) in option.column"
        :key="index"
        :align="tableColumnAlign(item)"
        :fixed="tableColumnFixed(item)"
        :label="item.label"
        :prop="item.prop"
        :type="item.colType"
        :width="tableColumnWidth(item)"
      >
        <template
          v-if="!['selection', 'index'].includes(item.colType as string)"
          #default="scoped: RSA"
        >
          <slot v-if="item.useSlot" :data="{ ...scoped, columnItem: item }" />

          <h-form
            v-else-if="item.useForm"
            :class-name="item.className || 'M0'"
            :form="scoped.row"
            :form-width="item.formWidth || 'auto'"
            :item-width="item.itemWidth || 'fit-content'"
            :label-width="item.labelWidth || 0"
            :option="item.formOption || []"
            :size="item.size || size"
            :style="{ 'justify-content': formAlign(item.align as string) }"
          />

          <span v-else :class="item.className" @click="click(item, scoped.row)">
            {{ showText(item, scoped.row) }}
          </span>
        </template>
      </el-table-column>
      <el-table-column
        v-if="operationShow"
        :label="option.operationLabel || '操作'"
        :width="option.operationWidth || 250"
        align="center"
        fixed="right"
      >
        <template #default="scope">
          <div class="flex-center">
            <h-form
              :author="author"
              :class-name="option.className || 'MX5'"
              :form="scope.row"
              :form-width="option.formWidth || 'auto'"
              :item-width="option.itemWidth || 'fit-content'"
              :label-width="option.labelWidth || 0"
              :option="tableOperationOption"
              :size="option.size || size"
              center
            />
          </div>
        </template>
      </el-table-column>
    </el-table>
    <!--分页-->
    <h-paging
      v-if="total >= 0"
      v-model:limit="LIMIT"
      v-model:page="PAGE"
      :total="total"
      @pagination="pagingChange"
    />
    <!--新增-->
    <el-dialog
      v-if="addDialog"
      v-model="addDialogVisible"
      :close-on-click-modal="false"
      :title="addDialog.title || '新增'"
      :width="VW(addDialog.width as string | number) || '18%'"
      append-to-body
      destroy-on-close
      draggable
      @close="close"
    >
      <h-form
        ref="addForm"
        :class-name="addDialog.className"
        :form="addDialog.form"
        :form-width="addDialog.formWidth"
        :item-width="addDialog.itemWidth"
        :label-width="addDialog.labelWidth"
        :option="addDialog.option"
        :rules="addDialog.rules"
        :size="addDialog.size || size"
        @change="dialogChange"
      />
      <template #footer>
        <el-button
          v-if="TRUE(addDialog.confirmBtn?.show)"
          :size="addDialog.confirmBtnSize || size"
          :type="addDialog.confirmBtnType"
          @click="addDialogVisible = false"
        >
          {{ addDialog.confirmBtnName || "取消" }}
        </el-button>
        <el-button
          v-if="TRUE(addDialog.cancelBtn?.show)"
          :size="addDialog.cancelBtnSize || size"
          :type="addDialog.cancelBtnType || 'primary'"
          @click="addSubmit"
        >
          {{ addDialog.cancelBtnName || "确定" }}
        </el-button>
      </template>
    </el-dialog>
    <!--修改-->
    <el-dialog
      v-if="updDialog"
      v-model="updDialogVisible"
      :close-on-click-modal="false"
      :title="updDialog.title || '编辑'"
      :width="VW(updDialog.width as string | number) || '18%'"
      append-to-body
      destroy-on-close
      draggable
      @close="close"
    >
      <h-form
        ref="updForm"
        :class-name="updDialog.className"
        :disabled="view"
        :form="updDialog.form"
        :form-width="updDialog.formWidth"
        :item-width="updDialog.itemWidth"
        :label-width="updDialog.labelWidth"
        :option="updDialog.option"
        :rules="updDialog.rules"
        :size="updDialog.size || size"
        @change="dialogChange"
      />
      <template #footer>
        <el-button
          v-if="TRUE(updDialog.confirmBtn?.show)"
          :size="updDialog.confirmBtnSize || size"
          :type="updDialog.confirmBtnType"
          @click="updDialogVisible = false"
        >
          {{ updDialog.confirmBtnName || "取消" }}
        </el-button>
        <el-button
          v-if="TRUE(updDialog.cancelBtn?.show)"
          :size="updDialog.cancelBtnSize || size"
          :type="updDialog.cancelBtnType || 'primary'"
          @click="updSubmit"
        >
          {{ updDialog.cancelBtnName || "确定" }}
        </el-button>
      </template>
    </el-dialog>
  </div>
</template>

<script lang="ts" setup>
import { ElMessage, ElMessageBox } from "element-plus"
import { computed, reactive, ref, watchEffect } from "vue"
import HForm, { FormProps } from "../hForm/index.vue"
import { FormOptionItem } from "../hForm/interface.ts"
import HExport, { ExportProps } from "../hExport/index.vue"
import HPaging from "../hPaging/index.vue"
import { day, type, validator } from "../../utils/tool"
import { elSize, RSA } from "../../utils/type.ts"
import {
  CRUDDialog,
  CRUDOperation,
  CRUDOption,
  CRUDOptionColumn
} from "./interface.ts"

// props
export interface CRUDProps {
  search?: FormProps
  operation?: CRUDOperation
  addDialog?: CRUDDialog
  updDialog?: CRUDDialog
  exportOption?: ExportProps
  data: RSA[]
  option: CRUDOption
  size?: elSize
  className?: string
  loading?: boolean
  total?: number
  limit?: number
  page?: number
  beforeRowAdd?: Function
  beforeRowUpd?: Function
  author?: RSA
}

const props = withDefaults(defineProps<CRUDProps>(), {
  total: -1,
  className: "P20 shadow bg-FFFFFF",
  beforeRowAdd: () => {
    return new Promise((resolve) => {
      resolve(true)
    })
  },
  beforeRowUpd: () => {
    return new Promise((resolve) => {
      resolve(true)
    })
  }
})
// emit name
const emit = defineEmits([
  "searchChange",
  "pagingChange",
  "dialogChange",
  "beforeAdd",
  "rowAdd",
  "beforeView",
  "beforeUpd",
  "rowUpd",
  "rowDel",
  "close",
  "selectionChange",
  "exportUpd",
  "exportDel",
  "setExport",
  "click",
  "update:limit",
  "update:page"
])
// data
let updDialog = reactive({} as CRUDDialog)
const view = ref(false)
const addDialogVisible = ref(false)
const updDialogVisible = ref(false)
const operationOption = ref([
  {
    key: "add",
    type: "button",
    content: "新增",
    show: true,
    click: () => {
      emit("beforeAdd")
      addDialogVisible.value = true
    }
  },
  {
    key: "export",
    type: "slot",
    content: "导出",
    show: false
  }
] as FormOptionItem[])
const tableOperationOption = ref([
  {
    key: "view",
    type: "button",
    content: "详情",
    plain: true,
    show: false,
    click: (o) => {
      view.value = true
      updDialog.form = { ...o }
      emit("beforeView", o)
      updDialogVisible.value = true
    }
  },
  {
    key: "upd",
    type: "button",
    content: "编辑",
    plain: true,
    show: true,
    click: (o) => {
      view.value = false
      updDialog.form = { ...o }
      emit("beforeUpd", o)
      updDialogVisible.value = true
    }
  },
  {
    key: "del",
    type: "button",
    content: "删除",
    show: true,
    btnType: "danger",
    plain: true,
    click: (o) => {
      ElMessageBox.confirm("此操作将删除该条数据, 是否继续?", "提示", {
        confirmButtonText: "确定",
        cancelButtonText: "取消",
        type: "warning"
      })
        .then(() => {
          emit("rowDel", o)
        })
        .catch(() => {
          ElMessage.info("已取消")
        })
    }
  }
] as FormOptionItem[])
// func
const searchChange = (o: RSA) => {
  emit("searchChange", o)
}
const pagingChange = (o: RSA) => {
  emit("pagingChange", o)
}
const dialogChange = (o: RSA) => {
  emit("dialogChange", o)
}
const addSubmit = () => {
  const addForm = ref()
  addForm.value.$refs.hForm.validate((valid: boolean) => {
    if (valid) {
      if (props.addDialog?.hasValRules?.length) {
        for (const item of props.addDialog.hasValRules) {
          if (props.addDialog.form[item.prop]) {
            const valid = validator(props.addDialog.form[item.prop], item.type)
            if (type(valid) === "String") {
              ElMessage.warning(valid)
              return
            }
            if (type(valid) === "Boolean" && !valid) {
              ElMessage.warning(item.message)
              return
            }
          }
        }
      }

      props.beforeRowAdd(props.addDialog?.form).then((e: boolean) => {
        if (!e) return e
        addDialogVisible.value = false
        emit("rowAdd", props.addDialog?.form)
      })
    }
  })
}
const updSubmit = () => {
  const updForm = ref()
  updForm.value.$refs.hForm.validate((valid: boolean) => {
    if (valid) {
      if (updDialog.hasValRules?.length) {
        for (const item of updDialog.hasValRules) {
          if (updDialog.form[item.prop]) {
            const valid = validator(updDialog.form[item.prop], item.type)
            if (type(valid) === "String") {
              ElMessage.warning(valid)
              return
            }
            if (type(valid) === "Boolean" && !valid) {
              ElMessage.warning(item.message)
              return
            }
          }
        }
      }

      props.beforeRowUpd(updDialog.form).then((e: boolean) => {
        if (!e) return e
        updDialogVisible.value = false
        emit("rowUpd", updDialog.form)
      })
    }
  })
}
const close = () => {
  emit("close")
}
const getSummaries = (o: RSA) => {
  const { columns } = o
  const sums = [] as string[] | number[]
  columns.forEach((column: RSA, index: number) => {
    if (index === 0) {
      sums[0] = "合计"
      return
    }
    if (props.option.summaryList?.length && props.option.summaryFields) {
      for (const item of props.option.summaryList) {
        if (column.property === item) {
          sums[index] = props.option.summaryFields[column.property]
        }
      }
    }
  })

  return sums
}
const selectionChange = (a: RSA[]) => {
  emit("selectionChange", a)
}
const setExport = (o: RSA) => {
  emit("setExport", o)
}
const exportUpd = (o: RSA) => {
  emit("exportUpd", o)
}
const exportDel = (o: RSA) => {
  emit("exportDel", o)
}
const click = (colItem: RSA, o: RSA) => {
  if (type(colItem.click) === "Function") colItem.click(o)
  emit("click", o)
}
// computed
const TRUE = computed(() => {
  return (b: boolean | undefined) => {
    return [true, false].includes(b as boolean) ? b : true
  }
})
const formAlign = computed(() => {
  return (s: string) => {
    if (s === "center") return "center"
    if (s === "right") return "flex-end"
    return "flex-start"
  }
})
const operationShow = computed(() => {
  const show = props.option.operationShow
  const dataLength = props.data.length > 0
  const hasItem = tableOperationOption.value.findIndex((o) => o.show) !== -1
  return show && dataLength && hasItem
})
const LoadingText = computed(() => {
  return (s: string) => {
    return s || "拼命加载中..."
  }
})
const LIMIT = computed({
  get() {
    return props.limit
  },
  set(n) {
    emit("update:limit", n)
  }
})
const PAGE = computed({
  get() {
    return props.page
  },
  set(n) {
    emit("update:page", n)
  }
})
const showText = computed(() => {
  return (colItem: RSA, o: RSA) => {
    if (colItem.unit) return o[colItem.prop] + colItem.unit
    if (colItem.date) return day.date(o[colItem.prop])
    if (colItem.datetime) return day.datetime(o[colItem.prop])
    return o[colItem.prop]
  }
})
const VW = computed(() => {
  return (v: string | number) => {
    if (type(v) === "Number") return `${v}vw`
    return v
  }
})
const tableColumnAlign = computed(() => {
  return (o: CRUDOptionColumn) => {
    if (
      ["selection", "index"].includes(o.colType as string) &&
      o.align === undefined
    ) {
      return "center"
    }
    return o.align
  }
})
const tableColumnFixed = computed(() => {
  return (o: CRUDOptionColumn) => {
    if (
      ["selection", "index"].includes(o.colType as string) &&
      o.fixed === undefined
    ) {
      return true
    }
    return o.fixed
  }
})
const tableColumnWidth = computed(() => {
  return (o: CRUDOptionColumn) => {
    if (
      ["selection", "index"].includes(o.colType as string) &&
      o.width === undefined
    ) {
      return 80
    }
    return o.width
  }
})
// watch
watchEffect(() => {
  updDialog = props.updDialog as CRUDDialog
  const { option, operation } = props
  // 表格配置项操作按钮
  if (option?.viewBtn) {
    tableOperationOption.value[0] = {
      ...tableOperationOption.value[0],
      ...option.viewBtn
    }
  }
  if (option?.updBtn) {
    tableOperationOption.value[1] = {
      ...tableOperationOption.value[1],
      ...option.updBtn
    }
  }
  if (option?.delBtn) {
    tableOperationOption.value[2] = {
      ...tableOperationOption.value[2],
      ...option.delBtn
    }
  }
  if (option?.customBtn?.length) {
    tableOperationOption.value = [
      ...tableOperationOption.value,
      ...option.customBtn
    ]
  }
  tableOperationOption.value = [...new Set(tableOperationOption.value)]
  // 操作区操作按钮配置项
  if (operation?.addBtn) {
    operationOption.value[0] = {
      ...operationOption.value[0],
      ...operation.addBtn
    }
  }
  if (operation?.exportBtn) {
    operationOption.value[1] = {
      ...operationOption.value[1],
      ...operation.exportBtn
    }
  }
  if (operation?.customBtn) {
    operationOption.value = [...operation.customBtn, ...operationOption.value]
  }
  operationOption.value = [...new Set(operationOption.value)]
})
</script>

<script lang="ts">
export default {
  name: "HCrud"
}
</script>
