<template>
  <div
    :class="{
      'limit-full': fileArray.length >= limit || limitFullUpd,
      load: loading
    }"
  >
    <el-upload
      ref="upload"
      :action="action"
      :before-upload="before"
      :data="data"
      :disabled="loading ? true : disabled"
      :drag="drag"
      :file-list="fileArray"
      :headers="headers"
      :limit="limitFullUpd || limit"
      :list-type="defaultListType"
      :multiple="multiple"
      :on-progress="progress"
      :on-remove="remove"
      :on-success="success"
    >
      <el-icon v-if="pictureCard">
        <component :is="'Plus'" />
      </el-icon>
      <template #file="{ file }">
        <div v-if="pictureCard && !loading" class="picture-card">
          <div v-if="breviaryPdf(file)" class="el-upload-list__item-thumbnail">
            <iframe :src="file['url']" class="iframe" />
          </div>
          <img
            v-if="breviaryImg(file)"
            :src="file['url']"
            alt=""
            class="el-upload-list__item-thumbnail"
          />
          <span class="el-upload-list__item-actions">
            <el-icon @click="preview(file)">
              <component :is="'ZoomIn'" />
            </el-icon>
            <el-icon @click="download(file)">
              <component :is="'Download'" />
            </el-icon>
            <el-icon v-if="!disabled" @click="remove(file)">
              <component :is="'Delete'" />
            </el-icon>
            <el-icon v-if="!disabled" @click="update(file)">
              <component :is="'Edit'" />
            </el-icon>
          </span>
        </div>
      </template>

      <el-icon v-if="drag" class="el-icon--upload">
        <component :is="'UploadFilled'" />
      </el-icon>
      <div v-if="drag" class="el-upload__text">
        将文件拖到此处，或
        <em>点击上传</em>
      </div>

      <el-button v-if="defaultShow" size="small" type="primary">
        {{ uploadText }}
      </el-button>

      <template #tip>
        <div v-if="defaultShow && tip" class="el-upload__tip">{{ tip }}</div>
      </template>
    </el-upload>

    <el-dialog v-model:visible="dialogVisible" append-to-body>
      <div v-if="['pdf'].includes(previewFileType)" class="iframe-box">
        <iframe :src="dialogUrl" class="iframe" />
      </div>

      <el-image
        v-if="['jpg', 'jpeg', 'png'].includes(previewFileType)"
        :preview-src-list="[dialogUrl]"
        :src="dialogUrl"
        style="width: 100%"
      />
    </el-dialog>
  </div>
</template>

<script lang="ts" setup>
// import * as events from "events"
import { ElMessage, UploadUserFile } from "element-plus"
import { computed, ref, watchEffect } from "vue"
import { fileLinkFileType, type } from "../../utils/tool"
import { elListType, RSA } from "../../utils/type.ts"

export interface UploadProps {
  action: string
  value: string | string[] | UploadUserFile[]
  listType?: elListType
  uploadText?: string
  tip?: string
  limit?: number
  drag?: boolean
  multiple?: boolean
  fileType?: string[]
  fileSize?: number
  disabled?: boolean
  headers?: RSA
  data?: RSA
}

const props = withDefaults(defineProps<UploadProps>(), {
  fileSize: 10,
  limit: undefined,
  uploadText: "点击上传",
  fileType: () => {
    return []
  },
  listType: "picture-card"
})

const loading = ref(false)
const defaultListType = ref("picture-card" as elListType)
const defaultFileType = ref([
  {
    key: "image/jpg",
    val: "jpg"
  },
  {
    key: "image/jpeg",
    val: "jpeg"
  },
  {
    key: "image/png",
    val: "png"
  },
  {
    key: "application/pdf",
    val: "pdf"
  },
  {
    key: "application/msword",
    val: "doc"
  },
  {
    key: "application/vnd.openxmlformats-officedocument.wordprocessingml.document",
    val: "docx"
  },
  {
    key: "application/vnd.ms-excel",
    val: "xsl"
  },
  {
    key: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
    val: "xslx"
  }
])
const fileArray = ref([] as UploadUserFile[])
const dialogUrl = ref("")
const dialogVisible = ref(false)
const state = ref("")
const uid = ref(undefined as number | undefined)
const limitFullUpd = ref(undefined as number | undefined)
const previewFileType = ref("" as string)

const pictureCard = computed(() => {
  return defaultListType.value === "picture-card"
})
const defaultShow = computed(() => {
  return ["text", "picture"].includes(defaultListType.value) && !props.drag
})
const breviaryPdf = computed(() => {
  return (item: RSA) => {
    if (item.name) {
      return ["pdf"].includes(fileLinkFileType(item.name) as string)
    }
    return ["pdf"].includes(fileLinkFileType(item.url) as string)
  }
})
const breviaryImg = computed(() => {
  return (item: RSA) => {
    if (item.name) {
      return ["jpg", "jpeg", "png"].includes(
        fileLinkFileType(item.name) as string
      )
    }
    return ["jpg", "jpeg", "png"].includes(fileLinkFileType(item.url) as string)
  }
})

const upload = ref()
const emit = defineEmits([
  "progress",
  "success",
  "update",
  "update:value",
  "remove"
])
// 文件上传
const progress = (event: RSA, file: RSA, fileList: RSA[]) => {
  emit("progress", event, file, fileList)
}
// 文件上传成功
const success = (
  response: RSA,
  file: UploadUserFile,
  fileList: UploadUserFile[]
) => {
  if (state.value === "update") {
    const nowIndex = fileList.findIndex((item) => item.uid === file.uid)
    fileList.splice(nowIndex, 1)
    const beforeIndex = fileList.findIndex((item) => item.uid === uid.value)
    fileList.splice(beforeIndex, 1, file)

    emit("update", response, file, fileList)
  } else {
    emit("update:value", fileList)
    emit("success", response, file, fileList)
  }

  state.value = "success"
  fileArray.value = fileList
  limitFullUpd.value = undefined
  loading.value = false
}
// 文件删除(slot)
const remove = (file: RSA) => {
  // 此判断用于上传校验return false会掉删除方法
  if (file && file.status === "success") {
    const index = fileArray.value.findIndex(
      (item: RSA) => item.uid === file.uid
    )
    fileArray.value.splice(index, 1)

    emit("update:value", fileArray.value)
    emit("remove", file, fileArray.value)
  }
}
// 文件修改(slot)
const update = (file: RSA) => {
  state.value = "update"
  uid.value = file.uid
  upload.value.$refs["upload-inner"].handleClick()
  if (props.limit && props.limit === fileArray.value.length)
    limitFullUpd.value = (props.limit as number) + 1
}
// 文件预览(slot)
const preview = (file: RSA) => {
  if (file.name) {
    previewFileType.value = fileLinkFileType(file.name)
  } else {
    previewFileType.value = fileLinkFileType(file.url)
  }
  dialogUrl.value = file.url
  dialogVisible.value = true
}
// 文件下载(slot)
const download = (file: RSA) => {
  const link = document.createElement("a")
  // 这里是将url转成blob地址，
  fetch(file.url)
    .then((res) => res.blob())
    .then((blob) => {
      // 将链接地址字符内容转变成blob地址
      link.href = window.URL.createObjectURL(blob)
      link.download = file.uid
      document.body.appendChild(link)
      link.click()
      document.body.removeChild(link)
      window.URL.revokeObjectURL(link.href)
    })
}
// 上传之前
const before = (file: RSA) => {
  // 构造使用者所需类型集合
  if (props.fileType.length > 0) {
    const list = []
    for (const item of defaultFileType.value) {
      for (const val of props.fileType) {
        if (val === item.val) list.push(item)
      }
    }
    defaultFileType.value = list
  }

  // 上传格式校验
  const index = defaultFileType.value.findIndex(
    (item: RSA) => item.key === file.type
  )
  if (index === -1) {
    let tip = ""
    for (const item of defaultFileType.value) {
      tip = `${tip} ${item.val}`
    }
    ElMessage.info(`仅支持上传${tip} 等格式`)
    return false
  }

  // 上传大小校验
  const fileSize = file.size / 1024 / 1024
  if (fileSize > props.fileSize) {
    ElMessage.info(`上传文件大小不能超过${props.fileSize}Mb`)
    return false
  }

  loading.value = true
}
watchEffect(() => {
  const { value, listType, drag } = props
  fileArray.value = []
  if (type(value) === "Array") {
    for (const item of value) {
      if (type(item) === "Object") {
        fileArray.value = value as UploadUserFile[]
      }
      if (type(item) === "String") {
        fileArray.value.push({ url: item } as UploadUserFile)
      }
    }
  }
  if (type(value) === "String") {
    fileArray.value = [{ url: value } as UploadUserFile]
  }

  if (listType && !drag) {
    defaultListType.value = listType
  }
})
</script>

<script lang="ts">
export default {
  name: "HUpload"
}
</script>

<style lang="scss" scoped>
.picture-card {
  width: 100%;
  height: 100%;

  i {
    font-size: 16px;
    margin: 0 5px;
    cursor: pointer;
  }
}

.limit-full {
  :deep(.el-upload--picture-card) {
    display: none;
  }
}

.load {
  @extend .limit-full;

  :deep(.el-upload-list__item-status-label) {
    visibility: hidden;
  }
}

:deep(.el-upload-list__item) {
  transition: none;
}

.iframe-box {
  height: 60vh;

  .iframe {
    width: 100%;
    height: 100%;
  }
}
</style>
