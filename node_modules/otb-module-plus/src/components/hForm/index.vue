<template>
  <el-form
    :ref="hFormRef"
    :class="center ? 'flex-center flew-warp' : 'flew-warp'"
    :label-position="labelPosition"
    :label-width="VW(labelWidth)"
    :model="result.form"
    :rules="rules"
    :size="size"
    :style="{ width: VW(formWidth), 'background-color': formBGC }"
  >
    <div
      v-for="(item, index) in domOption"
      :key="index"
      :draggable="FALSE(draggable)"
      @click="click($event, item, index)"
      @dragend="dragend($event, item, index)"
      @dragenter="dragenter($event, item, index)"
      @dragstart="dragstart($event, item, index)"
    >
      <el-form-item
        v-if="item.type && TRUE(item.show)"
        :class="itemClass(item)"
        :label="item.label"
        :label-width="VW(item.labelWidth as number|string)"
        :prop="item.prop"
      >
        <!--插槽-->
        <slot v-if="item.type === 'slot'" :data="{ form: result.form, item }" />
        <!--提示信息左侧-->
        <el-tooltip
          v-if="item.hintLeft"
          :content="item.hintLeft"
          placement="left"
        >
          <component
            :is="item.hintIcon || 'QuestionFilled'"
            class="MR10 pointer"
          />
        </el-tooltip>
        <!--输入框/文本框-->
        <el-input
          v-if="['input', 'textarea'].includes(item.type)"
          v-model="result.form[item.prop as string]"
          :clearable="TRUE(item.clearable)"
          :disabled="DISABLED(item, result.form)"
          :maxlength="item.maxlength"
          :minlength="item.minlength"
          :placeholder="item.placeholder || `请输入${item.label}`"
          :readonly="item.readonly"
          :rows="item.row || 2"
          :show-password="item.showPassword"
          :show-word-limit="item.showWordLimit"
          :size="item.size"
          :style="{ width: isVW(item) }"
          :type="item.inputType"
          @blur="blur($event, item)"
          @change="change(item)"
          @input="input($event, item)"
          @clear="clear($event, item)"
          @focus="focus($event, item)"
          @keyup.enter="enter(item)"
        >
          <template v-if="item.prepend" #prepend>
            <slot name="input-prepend" />
          </template>
          <template v-if="item.append" #append>
            <slot name="input-append" />
          </template>
          <template v-if="item.prefix" #prefix>
            <slot name="input-prefix" />
          </template>
          <template v-if="item.suffix" #suffix>
            <slot name="input-suffix" />
          </template>
        </el-input>
        <!--计数器/数字输入-->
        <el-input-number
          v-if="['number', 'inputNumber'].includes(item.type)"
          v-model="result.form[item.prop as string]"
          :class="item.type === 'number' ? 'el-input-number-align-left' : ''"
          :clearable="TRUE(item.clearable)"
          :controls="item.type === 'number' ? false : TRUE(item.controls)"
          :controls-position="item.controlsPosition"
          :disabled="DISABLED(item, result.form)"
          :max="item.max"
          :min="item.min || 0"
          :placeholder="item.placeholder || `请输入${item.label}`"
          :precision="item.precision"
          :size="item.size"
          :step="item.step"
          :step-strictly="item.stepStrictly"
          :style="{ width: isVW(item) }"
          @blur="blur($event, item)"
          @change="change(item)"
          @focus="focus($event, item)"
        />
        <!--下拉框-->
        <el-select
          v-if="item.type === 'select'"
          v-model="result.form[item.prop as string]"
          :allow-create="item.allowCreate"
          :clearable="TRUE(item.clearable)"
          :disabled="DISABLED(item, result.form)"
          :multiple="item.multiple"
          :placeholder="item.placeholder || `请选择${item.label}`"
          :size="item.size"
          :style="{ width: isVW(item) }"
          :value-key="item.valueKey"
          default-first-option
          filterable
          @blur="blur($event, item)"
          @clear="clear($event, item)"
          @focus="focus($event, item)"
          @change="change(item)"
        >
          <el-option
            v-for="(val, i) in item.option"
            :key="val[item.optionKey as string] || i"
            :disabled="val['disabled']"
            :label="val[item.optionVal as string] || val"
            :value="selectValue(item, val)"
          />
        </el-select>
        <!--级联选择-->
        <el-cascader
          v-if="item.type === 'cascader'"
          :key="timeStamp(item.key as boolean)"
          :ref="item.ref"
          v-model="result.form[item.prop as string]"
          :clearable="TRUE(item.clearable)"
          :collapse-tags="item.collapseTags"
          :debounce="item.debounce"
          :disabled="DISABLED(item, result.form)"
          :options="item.option"
          :placeholder="item.placeholder || `请选择${item.label}`"
          :props="item.props"
          :separator="item.separator"
          :size="item.size"
          :style="{ width: isVW(item) }"
          filterable
          @blur="blur($event, item)"
          @focus="focus($event, item)"
          @change="change(item)"
        />
        <!--级联面板-->
        <el-cascader-panel
          v-if="item.type === 'cascader-panel'"
          :key="timeStamp(item.key as boolean)"
          :ref="item.ref"
          v-model="result.form[item.prop as string]"
          :clearable="TRUE(item.clearable)"
          :placeholder="item.placeholder || `请选择${item.label}`"
          :collapse-tags="item.collapseTags"
          :debounce="item.debounce"
          :disabled="DISABLED(item, result.form)"
          :size="item.size || size"
          :options="item.option"
          :props="item.props"
          :separator="item.separator"
          :style="{ width: isVW(item) }"
          filterable
          @change="change(item)"
          @blur="blur($event, item)"
          @focus="focus($event, item)"
        />
        <!--时间选择框-->
        <el-time-picker
          v-if="['time', 'time-range'].includes(item.type)"
          v-model="result.form[item.prop as string]"
          :clearable="TRUE(item.clearable)"
          :disabled="DISABLED(item, result.form)"
          :format="item.format || valueFormat(item.type)"
          :end-placeholder="item.endPlaceholder || '结束时间'"
          :readonly="item.readonly"
          :is-range="item.type === 'time-range'"
          :placeholder="item.placeholder || `请选择${item.label}`"
          :size="item.size"
          :start-placeholder="item.startPlaceholder || '开始时间'"
          :style="{ width: isVW(item) }"
          :value-format="item.valueFormat || valueFormat(item.type)"
          range-separator="至"
          @blur="blur($event, item)"
          @change="change(item)"
          @focus="focus($event, item)"
        />
        <!--日期类型选择框-->
        <el-date-picker
          v-if="
            [
              'year',
              'years',
              'month',
              'months',
              'date',
              'dates',
              'datetime',
              'date-range',
              'datetime-range'
            ].includes(item.type)
          "
          v-model="result.form[item.prop as string]"
          :clearable="TRUE(item.clearable)"
          :editable="TRUE(item.editable)"
          :default-time="defaultTime(item)"
          :disabled="DISABLED(item, result.form)"
          :format="item.format || valueFormat(item.type)"
          :disabled-date="item.disabledDate"
          :placeholder="item.placeholder || `请选择${item.label}`"
          :readonly="item.readonly"
          :end-placeholder="item.endPlaceholder || '结束日期'"
          :range-separator="item.rangeSeparator || '至'"
          :size="item.size"
          :value-format="item.valueFormat || valueFormat(item.type)"
          :start-placeholder="item.startPlaceholder || '开始日期'"
          :style="{ width: isVW(item) }"
          :type="item.type.replace('-', '')"
          @blur="blur($event, item)"
          @change="change(item)"
        />
        <!--switch开关-->
        <div
          v-if="item.type === 'switch'"
          :style="{ width: isVW(item) }"
          class="align-left"
        >
          <el-switch
            v-model="result.form[item.prop as string]"
            :active-color="item.activeColor"
            :active-icon="item.activeIcon"
            :active-text="item.activeText"
            :active-value="item.activeValue"
            :disabled="DISABLED(item, result.form)"
            :inactive-color="item.inactiveColor"
            :inactive-icon="item.inactiveIcon"
            :inactive-text="item.inactiveText"
            :inactive-value="item.inactiveValue"
            :loading="item.loading"
            :size="item.size"
            :width="item.width"
            @change="change(item)"
          />
        </div>
        <!--展示文本 style="display: inline-flex; line-height: normal"-->
        <el-text
          v-if="item.type === 'text'"
          :class="item.textClassName"
          :size="item.size"
          :style="{ color: item.color, width: isVW(item) }"
          :tag="item.tag"
          :truncated="item.truncated"
          :type="item.textType"
        >
          {{ item.prop ? result.form[item.prop as string] : item.content }}
        </el-text>
        <!--标签-->
        <span
          v-if="item.type === 'tag'"
          :class="result.form[item.prop as string] ? '' : 'no-tag'"
          :style="{ color: item.color, width: isVW(item) }"
        >
          <el-tag
            :class="item.tagClassName"
            :size="item.size"
            :type="item.tagType"
            @click="btnClick(item)"
          >
            {{ result.form[item.prop as string] }}
          </el-tag>
        </span>
        <!--按钮-->
        <div
          v-if="item.type === 'button'"
          :class="item.btnClassName ? item.btnClassName : 'align-left'"
          :style="{ width: isVW(item) }"
        >
          <el-button
            :disabled="DISABLED(item, result.form)"
            :plain="item.plain"
            :size="item.size"
            :type="item.btnType || 'primary'"
            @click="btnClick(item)"
            @mouseover="btnMouseover(item)"
          >
            {{ item.content }}
          </el-button>
        </div>
        <!--附件上传-->
        <h-upload
          v-if="item.type === 'upload'"
          v-model:value="result.form[item.prop as string]"
          :action="item.action"
          :data="item.data"
          :disabled="DISABLED(item, result.form)"
          :drag="FALSE(item.drag)"
          :file-size="item.fileSize"
          :file-type="item.fileType"
          :headers="item.headers"
          :limit="item.limit"
          :list-type="item.listType"
          :multiple="FALSE(item.multiple)"
          :style="{ width: isVW(item) }"
          :tip="item.tip"
          :upload-text="item.uploadText"
          @remove="uploadRemove($event, item)"
          @success="uploadSuccess($event, item)"
          @update="uploadUpdate($event, item)"
        />
        <!--预览-->
        <h-preview
          v-if="item.type === 'preview'"
          :height="item.height"
          :style="{ width: isVW(item) }"
          :url="result.form[item.prop as string]"
          :url-list="item.urlList"
          :width="item.width"
        />
        <!--单选框-->
        <el-radio-group
          v-if="item.type === 'radio'"
          v-model="result.form[item.prop as string]"
          :disabled="DISABLED(item, result.form)"
          :fill="item.fill"
          :size="item.size"
          :style="{ width: isVW(item) }"
          :text-color="item.textColor"
          @change="change(item)"
        >
          <div v-if="!item.button">
            <el-radio
              v-for="(val, i) in item.option"
              :key="i"
              :border="item.border"
              :disabled="val['disabled']"
              :label="val[item.optionKey as string] || val"
            >
              {{ val[item.optionVal as string] || val }}
            </el-radio>
          </div>
          <div v-if="item.button">
            <el-radio-button
              v-for="(val, i) in item.option"
              :key="i"
              :disabled="val['disabled']"
              :label="val[item.optionKey as string] || val"
            >
              {{ val[item.optionVal as string] || val }}
            </el-radio-button>
          </div>
        </el-radio-group>
        <!--多选框-->
        <el-checkbox-group
          v-if="item.type === 'checkbox'"
          v-model="result.form[item.prop as string]"
          :disabled="DISABLED(item, result.form)"
          :fill="item.fill"
          :max="item.max"
          :min="item.min"
          :size="item.size"
          :style="{ width: isVW(item) }"
          :text-color="item.textColor"
          @change="change(item)"
        >
          <div v-if="!item.button">
            <el-checkbox
              v-for="(val, i) in item.option"
              :key="i"
              :border="FALSE(item.border)"
              :checked="val['checked']"
              :disabled="val['disabled']"
              :label="val[item.optionKey as string] || val"
            >
              {{ val[item.optionVal as string] || val }}
            </el-checkbox>
          </div>
          <div v-if="item.button">
            <el-checkbox-button
              v-for="(val, i) in item.option"
              :key="i"
              :checked="val['checked']"
              :disabled="val['disabled']"
              :label="val[item.optionKey as string] || val"
            >
              {{ val[item.optionVal as string] || val }}
            </el-checkbox-button>
          </div>
        </el-checkbox-group>
        <!--滑块-->
        <el-slider
          v-if="item.type === 'slider'"
          v-model="result.form[item.prop as string]"
          :debounce="item.debounce"
          :disabled="DISABLED(item, result.form)"
          :format-tooltip="item.formatTooltip"
          :height="item.height"
          :input-size="item.size"
          :marks="item.marks"
          :max="item.max"
          :min="item.min"
          :range="item.range"
          :show-input="item.showInput"
          :show-input-controls="item.showInputControls"
          :show-stops="item.showStops"
          :show-tooltip="item.tooltip"
          :step="item.step"
          :style="{ width: isVW(item) }"
          :tooltip-class="item.tooltipClass"
          :vertical="item.vertical"
          @change="change(item)"
          @input="input($event, item)"
        />
        <!--评分-->
        <el-rate
          v-if="item.type === 'rate'"
          v-model="result.form[item.prop as string]"
          :allow-half="item.allowHalf"
          :class="`MT${item.top || 11}`"
          :colors="item.colors"
          :disabled="DISABLED(item, result.form)"
          :disabled-void-color="item.disabledVoidColor"
          :disabled-void-icon="item.disabledVoidIcon"
          :high-threshold="item.highThreshold"
          :icon-classes="item.icon"
          :low-threshold="item.lowThreshold"
          :show-score="item.showScore"
          :show-text="item.showText"
          :style="{ width: isVW(item) }"
          :text-color="item.textColor"
          :texts="item.texts"
          :void-color="item.voidColor"
          :void-icon="item.voidIcon"
          score-template="{value}"
          @change="change(item)"
        />
        <!--分割线-->
        <div v-if="item.type === 'divider'" :style="{ width: isVW(item) }">
          <el-divider
            v-model="result.form[item.prop as string]"
            :content-position="item.contentPosition"
            :direction="item.vertical ? 'vertical' : 'horizontal'"
          >
            <component :is="item.dividerLeftIcon as string" />
            {{ item.content }}
            <component :is="item.dividerRightIcon as string" />
          </el-divider>
        </div>
        <!--提示信息右侧-->
        <el-tooltip
          v-if="item.hintRight"
          :content="item.hintRight"
          placement="right"
        >
          <component
            :is="item.hintIcon || 'QuestionFilled'"
            class="ML10 pointer"
          />
        </el-tooltip>
      </el-form-item>
    </div>
  </el-form>
</template>

<script lang="ts" setup>
import { computed, reactive, toRaw, watchEffect } from "vue"
import { type } from "../../utils/tool"
import HUpload from "../hUpload/index.vue"
import HPreview from "../hPreview/index.vue"
import { elLabelPosition, elSize, RSA } from "../../utils/type.ts"
import { FormOptionItem } from "./interface.ts"

// props 默认值
export interface FormProps {
  option: FormOptionItem[]
  form: RSA
  rules?: RSA
  hasValRules?: RSA[]
  size?: elSize
  labelWidth?: number | string
  formWidth?: number | string
  itemWidth?: number | string
  className?: string
  authority?: {
    key?: string
    arr?: RSA[]
  }
  disabled?: boolean
  center?: boolean
  labelBold?: boolean
  draggable?: boolean
  formBGC?: string
  labelPosition?: elLabelPosition
  hFormRef?: string
}

const props = withDefaults(defineProps<FormProps>(), {
  formWidth: "fit-content",
  itemWidth: "10vw",
  labelWidth: "auto",
  hFormRef: "hForm",
  labelBold: true
})
// 响应式数据
const result = reactive({
  option: [] as FormOptionItem[],
  form: {} as RSA
})
// 计算属性
const valueFormat = computed(() => {
  return (type: string) => {
    switch (type) {
      case "year":
        return "YYYY"
      case "years":
        return "YYYY"
      case "time":
        return "HH:mm:ss"
      case "month":
        return "YYYY-MM"
      case "months":
        return "YYYY-MM"
      case "date":
        return "YYYY-MM-DD"
      case "dates":
        return "YYYY-MM-DD"
      case "time-range":
        return "HH:mm:ss"
      case "date-range":
        return "YYYY-MM-DD"
      case "datetime":
        return "YYYY-MM-DD HH:mm:ss"
      case "datetime-range":
        return "YYYY-MM-DD HH:mm:ss"
      default:
        return "错误类型"
    }
  }
})
const itemClass = computed(() => {
  return (item: RSA) => {
    const { className, labelBold } = props
    if (labelBold) {
      if (item.className) return `${item.className} bolder`
      if (className) return `${className} bolder`
      return "bolder flex-center ML20"
    }
    return item.className || className || "flex-center ML20"
  }
})
const DISABLED = computed(() => {
  return (item: RSA, row: RSA) => {
    if (type(item.disabled) === "Boolean") {
      return item.disabled
    }
    if (type(item.disabledProp) === "String") {
      return Boolean(row[item.disabledProp])
    }
  }
})
const TRUE = computed(() => {
  return (item: boolean | undefined) => {
    return [true, false].includes(item as boolean) ? item : true
  }
})
const FALSE = computed(() => {
  return (item: boolean | undefined) => {
    return [true, false].includes(item as boolean) ? item : false
  }
})
const VW = computed(() => {
  return (v: number | string) => {
    if (type(v) === "Number") return `${v}vw`
    return v
  }
})
const isVW = computed(() => {
  return (o: FormOptionItem) => {
    if (o.itemWidth) {
      if (type(o.itemWidth) === "Number") return `${o.itemWidth}vw`
      return o.itemWidth
    }
    if (type(props.itemWidth) === "Number") return `${props.itemWidth}vw`
    return props.itemWidth
  }
})
const timeStamp = computed(() => {
  return (b: boolean | number | string) => {
    return (b as boolean) ? new Date().getTime() : undefined
  }
})
const selectValue = computed(() => {
  return (item: RSA, val: RSA | string | number) => {
    if (item.valueKey) return val
    if (item.optionKey) return (val as RSA)[item.optionKey as string]
    return val
  }
})
const defaultTime = computed(() => {
  return (o: FormOptionItem) => {
    const s = new Date(0, 0, 0)
    const e = new Date(0, 0, 0, 23, 59, 59)
    return ["date-range", "datetime-range"].includes(o.type)
      ? (o.defaultTime as [Date, Date]) || ([s, e] as [Date, Date])
      : (o.defaultTime as Date) || (s as Date)
  }
})
const domOption = computed(() => {
  return result.option.length ? result.option : props.option
})
// 方法 && 回调名称定义
const emit = defineEmits([
  "change",
  "blur",
  "input",
  "uploadUpdate",
  "uploadSuccess",
  "uploadRemove",
  "dragend",
  "dragenter",
  "dragstart",
  "click",
  "btnClick",
  "btnMouseover",
  "focus",
  "clear",
  "enter"
])
const change = (o: FormOptionItem) => {
  if (type(o.change) === "Function") o.change?.(result.form)
  emit("change", result.form)
}
const enter = (o: FormOptionItem) => {
  if (type(o.enter) === "Function") o.enter?.(result.form)
  emit("enter", result.form)
}
const blur = (e: Event, o: RSA) => {
  if (type(o.blur) === "Function") o.blur(e)
  emit("blur", e)
}
const input = (e: Event, o: RSA) => {
  if (type(o.input) === "Function") o.input(e)
  emit("input", e)
}
const focus = (e: Event, o: RSA) => {
  if (type(o.focus) === "Function") o.focus(e)
  emit("focus", e)
}
const clear = (e: Event, o: RSA) => {
  if (type(o.clear) === "Function") o.clear(e)
  emit("clear", e)
}
const uploadUpdate = (e: Event, o: RSA) => {
  if (type(o.update) === "Function") o.update(e)
  emit("uploadUpdate", e)
}
const uploadSuccess = (e: Event, o: RSA) => {
  if (type(o.success) === "Function") o.success(e)
  emit("uploadSuccess", e)
}
const uploadRemove = (e: Event, o: RSA) => {
  if (type(o.remove) === "Function") o.remove(e)
  emit("uploadRemove", e)
}
const dragend = (e: Event, o: RSA, i: number) => {
  emit("dragend", e, o, i)
}
const dragenter = (e: Event, o: RSA, i: number) => {
  emit("dragenter", e, o, i)
}
const dragstart = (e: Event, o: RSA, i: number) => {
  emit("dragstart", e, o, i)
}
const click = (e: Event, o: RSA, i: number) => {
  emit("click", e, o, i)
}
const btnClick = (o: FormOptionItem) => {
  if (type(o.click) === "Function") o.click?.(result.form)
  emit("btnClick", result.form)
}
const btnMouseover = (v: FormOptionItem) => {
  if (v && type(v.mouseover) === "Function") v.mouseover?.(result.form)
  emit("btnMouseover", result.form)
}
// 响应式追踪
watchEffect(() => {
  const { form, option, authority, disabled } = props
  // 表单对象
  result.form = form
  // 设置权限
  if (authority?.key && authority?.arr) {
    for (const item of option) {
      const boolean = type(item.show) === "Boolean"
      // item.show 为 true || 不是布尔值, 则遵循 item.key 为优先级
      if (((boolean && item.show) || !boolean) && item.key) {
        item.show = authority.arr.some(
          (v: RSA) => v[authority.key as string] === item.key
        )
      }
    }
  }
  // 表单禁用
  if (disabled) {
    result.option = toRaw(option)
    for (const item of result.option) {
      item.disabled = true
    }
  } else {
    result.option = []
  }
})
</script>

<script lang="ts">
export default {
  name: "HForm"
}
</script>
