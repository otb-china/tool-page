<template>
  <el-popover :placement="placement" trigger="click">
    <el-table
      v-loading="loading"
      :data="data"
      :element-loading-text="loadingText"
      :size="size"
      border
      max-height="500"
    >
      <el-table-column label="名称" width="400">
        <template #default="scoped: RSA">
          <div v-if="scoped.row['edit']" class="flex-row">
            <el-input v-model="scoped.row[name]" :size="size" />
            <el-button
              :size="size"
              class="ML20"
              plain
              type="primary"
              @click="exportUpd(scoped)"
            >
              保存
            </el-button>
          </div>
          <span v-else>{{ scoped.row[name] }}</span>
        </template>
      </el-table-column>
      <el-table-column :prop="createTime" label="创建时间" width="200" />
      <el-table-column align="center" label="操作" width="200">
        <template #default="scoped">
          <el-button
            :size="size"
            circle
            icon="Download"
            type="success"
            @click="exportDownload(scoped.row)"
          />
          <el-button
            v-if="updBtn"
            :size="size"
            circle
            icon="Edit"
            type="primary"
            @click="exportUpdOpen(scoped)"
          />
          <el-button
            v-if="delBtn"
            :size="size"
            circle
            icon="Delete"
            type="danger"
            @click="exportDel(scoped)"
          />
        </template>
      </el-table-column>
    </el-table>
    <template #reference>
      <el-button :size="btnSize" type="primary" @click="setExport">
        导出
      </el-button>
    </template>
  </el-popover>
</template>

<script lang="ts" setup>
import { ref, watchEffect } from "vue"
import { type } from "../../utils/tool"
import { elSize, RSA } from "../../utils/type.ts"

// props
export interface ExportProps {
  loading?: boolean
  placement?: string
  prop?: RSA
  size?: elSize
  btnSize?: elSize
  list: RSA[]
}

const props = withDefaults(defineProps<ExportProps>(), {
  modal: true,
  size: "small",
  placement: "bottom-end",
  list: () => {
    return []
  },
  prop: () => {
    return {}
  }
})
// emit name
const emit = defineEmits(["update:open", "exportUpd", "exportDel", "setExport"])
// data
const data = ref([] as RSA)
const name = ref("name")
const createTime = ref("created_at")
const updBtn = ref(true)
const delBtn = ref(true)
const loadingText = ref("努力加载中...")
const setExport = () => {
  // emit("setExport")
}
const exportDownload = (row: RSA) => {
  window.open(`${row.url}?attname=${row[name.value]}`)
}
const exportUpdOpen = (o: RSA) => {
  data.value[o.$index].edit = !o.row.edit
}
const exportUpd = (o: RSA) => {
  emit("exportUpd", o)
}
const exportDel = (o: RSA) => {
  emit("exportDel", o)
}
// watch
watchEffect(() => {
  const { prop, list } = props

  if (prop.name) name.value = prop.name
  if (prop.createTime) createTime.value = prop.createTime
  if (type(prop.updBtn) === "Boolean") updBtn.value = prop.updBtn
  if (type(prop.delBtn) === "Boolean") delBtn.value = prop.delBtn
  if (prop.loadingText) loadingText.value = prop.loadingText

  data.value = list
})
</script>

<script lang="ts">
export default {
  name: "HExport"
}
</script>

<style lang="scss" scoped>
:deep(.el-popover) {
  width: auto !important;
}
</style>
